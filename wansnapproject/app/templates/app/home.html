<!DOCTYPE html>
<html lang='ja'>

{% extends "app/base.html" %}
{% load static %}

{% block title %}ãƒ›ãƒ¼ãƒ ç”»é¢ - ãƒ¯ãƒ³ã‚¹ãƒŠãƒƒãƒ—{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'app/base.css' %}">
<link rel="stylesheet" href="{% static 'app/post.css' %}">
{% endblock %}

{% block content %}
    <h2>ğŸ ãƒ›ãƒ¼ãƒ ğŸ </h2>

    <div class="centered">
        <button type = "button" onclick="location.href='{% url 'create_post' %}'">ã†ã¡ã®å­æŠ•ç¨¿</button>
        <form method="get" action="{% url 'home' %}">
            <input type="text" name="q" placeholder="çŠ¬ç¨®ã‚„æœˆé½¢ãªã©ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›">
            <button type="submit" aria-label="æ¤œç´¢">ğŸ”</button>
    
            <div>
                <label>
                    <input type="radio" name="sort" value="new" {% if request.GET.sort == 'new' or not request.GET.sort %}checked{% endif %}>
                    æ–°ã—ã„é †
                </label>
        
                <label>
                    <input type="radio" name="sort" value="old" {% if request.GET.sort == 'old' %}checked{% endif %}>
                    å¤ã„é †
                </label>
            </div>
        </form>
    </div>
    
    <div class="image-grid">
        {% for post in posts %}
            <div class="image-card">
                <img src="{{ post.image.url }}"
                alt="æŠ•ç¨¿ç”»åƒ"
                class="post-image"
                onclick="openModal(this)"
                data-image="{{ post.image.url }}"
                data-name="{{ post.dog.dog_name }}"
                data-breed="{{ post.dog.breed }}"
                data-gender="{{ post.dog.gender }}"
                data-birthday-raw="{{ post.dog.birthday }}"
                data-birthday="{{ post.dog.birthday|date:'Y-m-d' }}"
                data-age-months="{{ post.dog.age_months}}"
                data-caption="{{ post.caption|default:' (ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãªã—) '|escapejs }}"
                data-post-id="{{ post.id }}"
                >
            </div>
        {% empty %}
            <p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
        {% endfor %}
    </div>

    <div id ="postModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img id="modal-image" src="" alt="æŠ•ç¨¿ç”»åƒ" style="width: 100%;"><br><br>

            <button id="favorite-button" data-post-id="">â˜†</button><br>

            <div class="dog-info-box">

            <div class="label">ã†ã¡ã®å­ã®åå‰</div>
            <div class="value" id="modal-name"></div><br>

            <div class="label">çŠ¬ç¨®</div>
            <div class="value" id="modal-breed"></div><br>
        
            <div class="label">æ€§åˆ¥</div>
            <div class="value" id="modal-gender"></div><br>
        
            <div class="label">ã†ã¡ã®å­ã®èª•ç”Ÿæ—¥</div>
            <div class="value" id="modal-birthday"></div><br>

            <div class="label">æœˆé½¢</div>
            <div class="value" id="modal-age-months"></div><br>

            <div class="label">ã†ã¡ã®å­ã‹ã‚‰ã²ã¨ã“ã¨</div>
            <div class="value" id="modal-caption"></div><br>

            </div>
        </div>
    </div>

    <script>
        function openModal(imgElement){
            const modal = document.getElementById("postModal");
            const modalImage = document.getElementById("modal-image");
            const image = imgElement.getAttribute('data-image');
            const name = imgElement.getAttribute('data-name');
            const breed = imgElement.getAttribute('data-breed');
            const gender = imgElement.getAttribute('data-gender');
            const birthdayRaw = imgElement.getAttribute('data-birthday-raw');
            const birthday = imgElement.getAttribute('data-birthday');
            const caption = imgElement.getAttribute('data-caption');
            const postId = imgElement.getAttribute('data-post-id');

            document.getElementById('modal-image').src = image;
            document.getElementById('modal-name').textContent = name;
            document.getElementById('modal-breed').textContent = breed;
            document.getElementById('modal-gender').textContent = gender;
            document.getElementById('modal-birthday').textContent = birthdayRaw;
            document.getElementById('modal-caption').textContent = caption; 

            if (birthday) {
                const birthDate = new Date(birthday);
                const today = new Date();

                let months =
                    (today.getFullYear() - birthDate.getFullYear()) * 12 +
                    (today.getMonth() - birthDate.getMonth());

                if (today.getDate() < birthDate.getDate()) {
                    months -= 1;
                }

                const year = Math.floor(months/12);
                const remainingMonths = months % 12;

                let ageText ="";
                if (year > 0) {
                    ageText += `${year}æ­³`;
                }
                if (remainingMonths > 0 || year === 0) {
                    ageText += `${remainingMonths}ãƒ¶æœˆ`;
                }

                document.getElementById('modal-age-months').textContent = ageText;
            } else {
                document.getElementById('modal-age-months').textContent = "ä¸æ˜";
            }

            document.getElementById('favorite-button').setAttribute('data-post-id', postId);

            fetch(`/is_favorited/?post_id=${postId}`)
                .then(response => response.json())
                .then(data => {
                    const favBtn = document.getElementById('favorite-button');
                    favBtn.textContent = data.is_favorited ? 'â˜…' : 'â˜†';
                });
            
            document.getElementById('postModal').style.display = "block";
        }

        document.addEventListener('DOMContentLoaded', function (){
            const modal = document.getElementById('postModal');
            const closeBtn = modal.querySelector('.close');
            const favBtn = document.getElementById('favorite-button');

            closeBtn.onclick = function () {
                modal.style.display = "none";
            };

            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            };
                
            favBtn.onclick = function () {
                const postId = this.getAttribute('data-post-id');
                fetch(`/toggle_favorite/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `post_id=${postId}`
                })
                .then(response => response.json())
                .then(data => {
                    if(data.status === 'added') {
                        favBtn.textContent = 'â˜…';
                    } else if (data.status === 'removed') {
                        favBtn.textContent = 'â˜†';
                    }
                });
            };
        });
    </script>
    
{% endblock %}
    